<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R for Transcriptomics & Single-Cell - Lesson 2</title>
    <script src="https://cdn.jsdelivr.net/npm/ace-builds@1.32.6/src-min-noconflict/ace.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ace-builds@1.32.6/src-min-noconflict/mode-r.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ace-builds@1.32.6/src-min-noconflict/theme-monokai.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/webr@0.2.2/dist/webr.mjs" type="module"></script>
    <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            color: #00ff88;
            height: 100%;
            overflow: hidden;
        }

        html {
            height: 100%;
        }

        .container {
            display: flex;
            height: 100vh;
            position: relative;
        }

        .left-panel {
            width: 45%;
            background: rgba(0, 0, 0, 0.8);
            border-right: 2px solid #00ff88;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }

        .right-panel {
            width: 55%;
            display: flex;
            flex-direction: column;
            background: rgba(10, 10, 10, 0.9);
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            border: 2px solid #00ff88;
            border-radius: 10px;
            background: rgba(0, 255, 136, 0.1);
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.2);
        }

        .header h1 {
            margin: 0;
            font-size: 1.5rem;
            text-shadow: 0 0 10px #00ff88;
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { text-shadow: 0 0 10px #00ff88; }
            to { text-shadow: 0 0 20px #00ff88, 0 0 30px #00ff88; }
        }

        .mode-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .mode-btn {
            padding: 10px 15px;
            background: rgba(0, 255, 136, 0.2);
            border: 1px solid #00ff88;
            color: #00ff88;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .mode-btn:hover, .mode-btn.active {
            background: rgba(0, 255, 136, 0.4);
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
            border: 1px solid #00ff88;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff88, #00cc66);
            width: 0%;
            transition: width 0.5s ease;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }

        .content-area {
            flex: 1;
            overflow-y: auto;
        }

        .question-card {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid #00ff88;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.2);
        }

        .question-card h3 {
            margin-top: 0;
            color: #00ffcc;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin: 10px 0;
        }

        .option {
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #555;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .option:hover {
            background: rgba(0, 255, 136, 0.2);
            border-color: #00ff88;
        }

        .option.correct {
            background: rgba(0, 255, 0, 0.3);
            border-color: #00ff00;
        }

        .option.incorrect {
            background: rgba(255, 0, 0, 0.3);
            border-color: #ff0000;
        }

        .feedback {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }

        .feedback.correct {
            background: rgba(0, 255, 0, 0.2);
            color: #00ff00;
        }

        .feedback.incorrect {
            background: rgba(255, 0, 0, 0.2);
            color: #ff6666;
        }

        .code-editor {
            height: 300px;
            border: 2px solid #00ff88;
            border-radius: 5px;
            margin: 10px;
        }

        .output-area {
            flex: 1;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #00ff88;
            border-radius: 5px;
            margin: 10px;
            padding: 15px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
        }

        .run-btn {
            margin: 10px;
            padding: 12px 24px;
            background: linear-gradient(45deg, #00ff88, #00cc66);
            border: none;
            color: #000;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        .run-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.4);
        }

        .run-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .story-mode {
            text-align: center;
            padding: 20px;
        }

        .level-card {
            background: rgba(0, 255, 136, 0.1);
            border: 2px solid #00ff88;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .level-card:hover {
            background: rgba(0, 255, 136, 0.2);
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0, 255, 136, 0.3);
        }

        .level-card.completed {
            background: rgba(0, 255, 0, 0.2);
            border-color: #00ff00;
        }

        .level-card.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .input-field {
            width: 100%;
            padding: 8px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #00ff88;
            color: #00ff88;
            border-radius: 3px;
            font-family: inherit;
            margin: 5px 0;
        }

        .score-display {
            text-align: center;
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #00ffcc;
        }

        .typing-animation {
            overflow: hidden;
            border-right: 2px solid #00ff88;
            white-space: nowrap;
            animation: typing 3s steps(40, end), blink-caret 0.75s step-end infinite;
        }

        @keyframes typing {
            from { width: 0; }
            to { width: 100%; }
        }

        @keyframes blink-caret {
            from, to { border-color: transparent; }
            50% { border-color: #00ff88; }
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .left-panel, .right-panel {
                width: 100%;
            }
            
            .left-panel {
                height: 40vh;
            }
            
            .right-panel {
                height: 60vh;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="left-panel">
            <div class="header">
                <h1>R for Transcriptomics & Single-Cell</h1>
                <p>Lesson 2: Words (Data Types & Objects)</p>
                <p style="color: #00ffcc; font-size: 0.9em;">üë§ Student: Bio-Learner</p>
            </div>

            <div class="mode-selector">
                <button class="mode-btn active" onclick="switchMode('quiz')">Quiz Mode</button>
                <button class="mode-btn" onclick="switchMode('practice')">Practice Mode</button>
                <button class="mode-btn" onclick="switchMode('story')">R Quest</button>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <div class="score-display" id="scoreDisplay">Score: 0/0</div>

            <div class="content-area" id="contentArea">
                </div>
        </div>

        <div class="right-panel">
            <div class="code-editor" id="codeEditor"></div>
            <button class="run-btn" id="runBtn" onclick="runCode()">‚ñ∂ Run Code</button>
            <div class="output-area" id="outputArea">Welcome to the R Console! üß¨
Ready to explore transcriptomics and single-cell analysis...

Type your R code in the editor above and click "Run Code" to execute.
            </div>
        </div>
    </div>

    <script type="module">
        // Initialize WebR
        import { WebR } from 'https://cdn.jsdelivr.net/npm/webr@0.2.2/dist/webr.mjs';
        
        let webR;
        let editor;
        let currentMode = 'quiz';
        let currentQuestionIndex = 0;
        let score = 0;
        let totalQuestions = 0;
        let userName = 'Bio-Learner'; // Hardcoded for Lesson 2
        let sessionStartTime = new Date(); // Start session immediately

        // Lesson data for Lesson 2
        const lessonData = {
            "mcq": [
                {"q": "What is the primary data type for whole numbers (integers) in R?", "options": ["character", "logical", "numeric", "complex"], "answer": "numeric"},
                {"q": "Which data type can only hold TRUE or FALSE values?", "options": ["character", "logical", "integer", "factor"], "answer": "logical"},
                {"q": "What is the result when you combine a numeric value and a character string in a vector (e.g., c(1, 'gene'))?", "options": ["It remains mixed type", "The numeric value is converted to logical", "The numeric value is coerced to character", "An error occurs"], "answer": "The numeric value is coerced to character"},
                {"q": "Which of these is the function to check for missing values?", "options": ["is.null()", "na.check()", "is.missing()", "is.na()"], "answer": "is.na()"},
                {"q": "Which argument is used in functions like mean() to automatically remove missing values (NA)?", "options": ["na.remove=TRUE", "NA.rm=TRUE", "na.rm=TRUE", "remove.na=TRUE"], "answer": "na.rm=TRUE"}
            ],
            "true_false": [
                {"q": "The class() function is used to determine the storage mode of an object.", "answer": false}, // The class() function determines the object's class, not necessarily the storage mode (which is typeof())
                {"q": "A single TRUE value in R is treated as 1 in mathematical operations.", "answer": true},
                {"q": "sum(c(1, 2, NA, 4)) will return the sum of the non-missing values.", "answer": false}, // It will return NA unless na.rm=TRUE
                {"q": "The typeof() function is generally more specific than class().", "answer": true},
                {"q": "You can use the as.numeric() function to convert a character vector of numbers to numeric.", "answer": true}
            ],
            "fill": [
                {"q": "The data type for text in R is __________.", "answer": "character"},
                {"q": "The value used to represent a missing value in R is __________.", "answer": "NA"},
                {"q": "To count the number of elements in an object, you use the __________ function.", "answer": "length()"},
                {"q": "To convert an object to a different type, R provides functions like as.__________().", "answer": "as.numeric()"}
            ]
        };

        const practiceExercises = [
            {
                title: "Data Type Check",
                description: "Create a numeric 'count', a character 'gene_id', and a logical 'expressed' object. Check the class of all three.",
                starter: "# Create objects\ncount <- 50\ngene_id <- 'TP53'\nexpressed <- TRUE\n\n# Check classes\nclass(count)\nclass(gene_id)\nclass(expressed)",
                solution: "count <- 50\ngene_id <- 'TP53'\nexpressed <- TRUE\n\nclass(count)\nclass(gene_id)\nclass(expressed)"
            },
            {
                title: "Missing Data Handling",
                description: "Create a vector x with a missing value (NA). Use is.na() to identify the missing value, then calculate the mean *removing* NA.",
                starter: "# Create vector with NA\nx <- c(1, 5, NA, 8)\n\n# Identify NA\nis.na(x)\n\n# Calculate mean (remove NA)",
                solution: "x <- c(1, 5, NA, 8)\n\nis.na(x)\nmean(x, na.rm=TRUE)"
            },
            {
                title: "Function Creation",
                description: "Create a function called 'square_it' that takes one argument, 'num', and returns the square of that number.",
                starter: "# Define the function\nsquare_it <- function(num) {\n  \n}\n\n# Test the function\nsquare_it(9)",
                solution: "square_it <- function(num) {\n  return(num ^ 2)\n}\n\nsquare_it(9)"
            }
        ];

        const storyLevels = [
            {
                id: 1,
                title: "Data Type Decipher",
                description: "Identify and create the core data types: numeric (42.5), character ('RNA'), and logical (FALSE).",
                challenge: "Create variables: expression_val <- 42.5, molecule <- 'RNA', and is_valid <- FALSE. Check their classes.",
                completed: false
            },
            {
                id: 2,
                title: "Missing Value Trap",
                description: "Find and handle the missing data points in a gene count vector.",
                challenge: "Create vector: counts <- c(10, 20, NA, 50). Use is.na(counts) and then mean(counts, na.rm=TRUE).",
                completed: false
            },
            {
                id: 3,
                title: "Vector Coercion Lock",
                description: "Observe R's coercion rules by combining different types in a single vector.",
                challenge: "Create vector: mix <- c(100, 'GeneX', TRUE). Check the class of 'mix' and explain the result in a comment.",
                completed: false
            },
            {
                id: 4,
                title: "Function Forge",
                description: "Define a simple function to automate a calculation for the reactor.",
                challenge: "Create a function 'calc_log2' that takes 'x' and returns log2(x+1). Test it with calc_log2(7).",
                completed: false
            },
            {
                id: 5,
                title: "Logical Gate",
                description: "Use logical operations to filter and count elements.",
                challenge: "Create: status <- c(TRUE, TRUE, FALSE, TRUE). Use sum(status) and length(status).",
                completed: false
            }
        ];

        // --- Core Application Logic (Same as Lesson 1, adapted for Lesson 2) ---

        // Initialize the application
        async function init() {
            // NOTE: The login screen is intentionally skipped for Lesson 2
            const name = sessionStorage.getItem("userName");
			if (!name) {
                alert('Please enter your name to continue.');
                window.location.href = "./Login.html";
				return;
            }
            try {
                // Initialize WebR
                webR = new WebR();
                await webR.init();
                
                // Initialize Ace Editor
                editor = ace.edit("codeEditor");
                editor.setTheme("ace/theme/monokai");
                editor.session.setMode("ace/mode/r");
                editor.setOptions({
                    fontSize: 14,
                    showLineNumbers: true,
                    showGutter: true,
                    highlightActiveLine: true,
                    wrap: true
                });
                
                // Set initial code
                editor.setValue("# Welcome to R Lesson 2: Data Types!\n# Try: num <- 10; class(num)\n", -1);
                
                // Load saved progress (simplified, using 'Bio-Learner' as user)
                loadProgress();
                
                // Initialize quiz mode
                switchMode('quiz');
                
                document.getElementById('outputArea').textContent = "‚úÖ R Console Ready!\nWebR initialized successfully. You can now run R code!\n\nLesson 2 Focus: numeric, character, logical, NA, functions.\n\nTry:\n‚Ä¢ class(3.14)\n‚Ä¢ class('A gene')\n‚Ä¢ is.na(NA)";
                
            } catch (error) {
                console.error('Initialization error:', error);
                document.getElementById('outputArea').textContent = "‚ùå Error initializing R environment.\nFalling back to demo mode...\n\nYou can still practice R syntax, but code execution is limited.";
            }
        }

        // Switch between modes
        window.switchMode = function(mode) {
            currentMode = mode;
            
            // Update active button
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            // Use event.target if available, otherwise find the button manually
            const targetBtn = event ? event.target : document.querySelector(`.mode-btn[onclick*="switchMode('${mode}')"]`);
            //if (targetBtn) targetBtn.classList.add('active');
            
            // Reset state
            currentQuestionIndex = 0;
            
            switch(mode) {
                case 'quiz':
                    loadQuizMode();
                    break;
                case 'practice':
                    loadPracticeMode();
                    break;
                case 'story':
                    loadStoryMode();
                    break;
            }
        };

        // Load quiz mode
        function loadQuizMode() {
            const allQuestions = [
                ...lessonData.mcq.map(q => ({...q, type: 'mcq'})),
                ...lessonData.true_false.map(q => ({...q, type: 'true_false'})),
                ...lessonData.fill.map(q => ({...q, type: 'fill'}))
            ];
            
            totalQuestions = allQuestions.length;
            updateScore();
            
            if (currentQuestionIndex < allQuestions.length) {
                displayQuestion(allQuestions[currentQuestionIndex]);
            } else {
                showQuizComplete();
            }
        }

        // Display a question
        function displayQuestion(question) {
            const contentArea = document.getElementById('contentArea');
            let html = `<div class="question-card">
                <h3>Question ${currentQuestionIndex + 1} of ${totalQuestions}</h3>
                <p>${question.q}</p>`;

            if (question.type === 'mcq') {
                html += '<div class="options">';
                question.options.forEach((option, index) => {
                    html += `<div class="option" onclick="selectOption('${option}', '${question.answer}')">${option}</div>`;
                });
                html += '</div>';
            } else if (question.type === 'true_false') {
                html += '<div class="options">';
                html += `<div class="option" onclick="selectOption(true, ${question.answer})">True</div>`;
                html += `<div class="option" onclick="selectOption(false, ${question.answer})">False</div>`;
                html += '</div>';
            } else if (question.type === 'fill') {
                html += `<input type="text" class="input-field" id="fillAnswer" placeholder="Type your answer here..." onkeypress="if(event.key==='Enter') checkFillAnswer('${question.answer}')">`;
                html += `<button class="mode-btn" onclick="checkFillAnswer('${question.answer}')" style="margin-top: 10px;">Submit</button>`;
            }

            html += '<div id="feedback"></div></div>';
            contentArea.innerHTML = html;
            
            updateProgress();
        }

        // Handle option selection
        window.selectOption = function(selected, correct) {
            const options = document.querySelectorAll('.option');
            const feedback = document.getElementById('feedback');
            
            options.forEach(option => {
                option.style.pointerEvents = 'none';
                if (option.textContent.trim() === correct.toString().trim() || option.textContent.trim() === correct.trim()) {
                    option.classList.add('correct');
                } else if (option.textContent.trim() === selected.toString().trim() || option.textContent.trim() === selected.trim()) {
                    option.classList.add('incorrect');
                }
            });
            
            if (selected.toString().trim() === correct.toString().trim() || selected.trim() === correct.trim()) {
                feedback.innerHTML = '‚úÖ Correct! Well done!';
                feedback.className = 'feedback correct';
                score++;
                playSound('correct');
            } else {
                feedback.innerHTML = `‚ùå Incorrect. The correct answer is: ${correct}`;
                feedback.className = 'feedback incorrect';
                playSound('incorrect');
            }
            
            updateScore();
            
            setTimeout(() => {
                currentQuestionIndex++;
                loadQuizMode();
            }, 2000);
        };

        // Check fill-in-the-blank answer
        window.checkFillAnswer = function(correct) {
            const input = document.getElementById('fillAnswer');
            const answer = input.value.trim().toLowerCase();
            const correctLower = correct.toLowerCase().replace(/['"()]/g, ''); // Clean up for comparison
            const feedback = document.getElementById('feedback');
            
            input.disabled = true;
            
            if (answer === correctLower) {
                feedback.innerHTML = '‚úÖ Correct! Well done!';
                feedback.className = 'feedback correct';
                score++;
                playSound('correct');
            } else {
                feedback.innerHTML = `‚ùå Incorrect. The correct answer is: ${correct}`;
                feedback.className = 'feedback incorrect';
                playSound('incorrect');
            }
            
            updateScore();
            
            setTimeout(() => {
                currentQuestionIndex++;
                loadQuizMode();
            }, 2000);
        };

        // Load practice mode
        function loadPracticeMode() {
            const contentArea = document.getElementById('contentArea');
            let html = '<h2>Practice Exercises</h2>';
            
            practiceExercises.forEach((exercise, index) => {
                html += `<div class="question-card">
                    <h3>${exercise.title}</h3>
                    <p>${exercise.description}</p>
                    <button class="mode-btn" onclick="loadExercise(${index})">Start Exercise</button>
                </div>`;
            });
            
            contentArea.innerHTML = html;
        }

        // Load exercise
        window.loadExercise = function(index) {
            const exercise = practiceExercises[index];
            editor.setValue(exercise.starter, -1);
            
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `<div class="question-card">
                <h3>${exercise.title}</h3>
                <p>${exercise.description}</p>
                <button class="mode-btn" onclick="showSolution(${index})">Show Solution</button>
                <button class="mode-btn" onclick="loadPracticeMode()">Back to Exercises</button>
            </div>`;
        };

        // Show solution
        window.showSolution = function(index) {
            const exercise = practiceExercises[index];
            editor.setValue(exercise.solution, -1);
        };

        // Load story mode
        function loadStoryMode() {
            const contentArea = document.getElementById('contentArea');
            let html = `<div class="story-mode">
                <h2 class="typing-animation">üß¨ R Quest: The Genomics Lab</h2>
                <p>You are moving up to the next console! Master data types and objects to unlock the RNA-seq pipeline.</p>
            `;
            
            storyLevels.forEach((level, index) => {
                const isLocked = index > 0 && !storyLevels[index - 1].completed;
                const cardClass = level.completed ? 'level-card completed' : isLocked ? 'level-card locked' : 'level-card';
                
                html += `<div class="${cardClass}" onclick="${isLocked ? '' : `startLevel(${index})`}">
                    <h3>${level.completed ? '‚úÖ' : isLocked ? 'üîí' : 'üîì'} Level ${level.id}: ${level.title}</h3>
                    <p>${level.description}</p>
                    ${level.completed ? '<p style="color: #00ff00;">COMPLETED</p>' : ''}
                </div>`;
            });
            
            html += '</div>';
            contentArea.innerHTML = html;
        }

        // Start story level
        window.startLevel = function(index) {
            const level = storyLevels[index];
            const contentArea = document.getElementById('contentArea');
            
            contentArea.innerHTML = `<div class="question-card">
                <h3>Level ${level.id}: ${level.title}</h3>
                <p>${level.description}</p>
                <p><strong>Challenge:</strong> ${level.challenge}</p>
                <button class="mode-btn" onclick="completeLevel(${index})">Complete Level</button>
                <button class="mode-btn" onclick="loadStoryMode()">Back to Quest</button>
            </div>`;
            
            // Set appropriate starter code based on level
            const starterCodes = [
                "# Level 1: Data Type Decipher\n# Create the variables and check their types\nexpression_val <- \nmolecule <- \nis_valid <- \n\nclass(expression_val)\nclass(molecule)\nclass(is_valid)",
                "# Level 2: Missing Value Trap\n# Find the NA and calculate the clean mean\ncounts <- c(10, 20, NA, 50)\n\n# Check for NA\n\n# Calculate mean without NA",
                "# Level 3: Vector Coercion Lock\n# Create the mix vector and check its class\nmix <- c(100, 'GeneX', TRUE)\n\n# Check class of mix\n\n# Add a comment to explain the class\n# ",
                "# Level 4: Function Forge\n# Define and test the log2 function\ncalc_log2 <- function(x) {\n  \n}\n\ncalc_log2(7)",
                "# Level 5: Logical Gate\n# Use logical vector for counting\nstatus <- c(TRUE, TRUE, FALSE, TRUE)\n\n# Calculate how many TRUEs exist\n\n# Calculate total length"
            ];
            
            editor.setValue(starterCodes[index], -1);
        };

        // Complete story level
        window.completeLevel = function(index) {
            storyLevels[index].completed = true;
            saveProgress();
            
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `<div class="question-card">
                <h3>‚úÖ Level ${storyLevels[index].id} Complete!</h3>
                <p class="typing-animation">Data types locked in. Proceed to next module...</p>
                <button class="mode-btn" onclick="loadStoryMode()">Continue Quest</button>
            </div>`;
            
            // Check if all levels completed
            if (storyLevels.every(level => level.completed)) {
                const sessionDuration = sessionStartTime ? Math.round((new Date() - sessionStartTime) / 60000) : 0;
                const completedLevels = storyLevels.filter(level => level.completed).length;
                
                const finalCode = editor.getValue(); 

                saveFinalResults('Story Mode (R Quest)', completedLevels, storyLevels.length, 100, sessionDuration, finalCode);
                
                setTimeout(() => {
                    contentArea.innerHTML = `<div class="question-card" style="text-align: center;">
                        <h2>üéâ RNA-SEQ PIPELINE UNLOCKED! üéâ</h2>
                        <p class="typing-animation">You are now fluent in R Data Types and Objects!</p>
                        <div style="background: rgba(0, 255, 136, 0.1); padding: 15px; border-radius: 8px; margin: 15px 0;">
                            <h3>üèÜ Quest Complete!</h3>
                            <p><strong>Student:</strong> ${userName}</p>
                            <p><strong>Levels Completed:</strong> ${completedLevels}/${storyLevels.length}</p>
                            <p><strong>Time Spent:</strong> ${sessionDuration} minutes</p>
                            <p><strong>Completion Date:</strong> ${new Date().toLocaleString()}</p>
                        </div>
                        <p>Congratulations! You've mastered the building blocks of R for bioinformatics.</p>
                        <div style="margin-top: 20px;">
                            <button class="mode-btn" onclick="loadStoryMode()">View Quest Summary</button>
                            <button class="mode-btn" onclick="downloadResults()">üì• Download Results</button>
                        </div>
                        <p style="color: #00ffcc; font-size: 0.9em; margin-top: 15px;">
                            ‚úÖ Results automatically saved to instructor's Google Sheet
                        </p>
                    </div>`;
                }, 2000);
            }
        };

        // Run R code (uses WebR)
        window.runCode = async function() {
            const code = editor.getValue();
            const outputArea = document.getElementById('outputArea');
            const runBtn = document.getElementById('runBtn');
            
            if (!code.trim()) {
                outputArea.textContent = "Please enter some R code to execute.";
                return;
            }
            
            runBtn.disabled = true;
            runBtn.textContent = "Running...";
            outputArea.textContent = "Executing R code...\n";
            
            try {
                if (webR) {
                    // Execute with WebR
                    const result = await webR.evalR(code);
                    // Capture all output from WebR
                    const output = await webR.flush(); 
                    let outputText = output.output.map(item => item.data).join('\n');
                    
                    // Add result of the last expression if it's not empty
                    if (result && result.toString() !== 'NULL') {
                        outputText += `\n${result.toString()}`;
                    }

                    outputArea.textContent = `> ${code}\n\n${outputText || "Code executed successfully."}`;

                } else {
                    // Fallback simulation
                    simulateRExecution(code, outputArea);
                }
            } catch (error) {
                outputArea.textContent = `> ${code}\n\nError: ${error.message}`;
            } finally {
                runBtn.disabled = false;
                runBtn.textContent = "‚ñ∂ Run Code";
            }
        };

        // Simulate R execution for demo purposes (Updated for Lesson 2 concepts)
        function simulateRExecution(code, outputArea) {
            const lines = code.split('\n').filter(line => line.trim() && !line.trim().startsWith('#'));
            let output = `> ${code}\n\n`;
            
            lines.forEach(line => {
                const trimmed = line.trim();
                
                if (trimmed.includes('class(') || trimmed.includes('typeof(')) {
                    // Simple class/typeof simulation
                    if (trimmed.includes("'")) output += `[1] "character"\n`;
                    else if (trimmed.includes("TRUE") || trimmed.includes("FALSE")) output += `[1] "logical"\n`;
                    else output += `[1] "numeric"\n`;
                } else if (trimmed.includes('is.na(')) {
                    output += `[1] FALSE FALSE TRUE FALSE\n`;
                } else if (trimmed.includes('mean(')) {
                    if (trimmed.includes('na.rm=TRUE')) output += `[1] 4.666667\n`;
                    else if (trimmed.includes('NA')) output += `[1] NA\n`;
                    else output += `[1] 5.5\n`;
                } else if (trimmed.includes('sum(') && !trimmed.includes('TRUE')) {
                    if (trimmed.includes('"')) output += `Error in sum("A", "B"): invalid 'type' of argument\n`;
                    else output += `[1] 10\n`; 
                } else if (trimmed.includes('sum(') && trimmed.includes('TRUE')) {
                    output += `[1] 3\n`;
                } else if (trimmed.includes('length(')) {
                    output += `[1] 4\n`; 
                } else if (trimmed.includes('<-')) {
                    output += `# Variable/Function defined\n`;
                } else if (trimmed.includes('c(') && trimmed.includes('"')) {
                    output += `# Vector coerced to character\n`;
                } else {
                    output += `# Code executed\n`;
                }
            });
            
            outputArea.textContent = output;
        }

        // Update score display
        function updateScore() {
            document.getElementById('scoreDisplay').textContent = `Score: ${score}/${totalQuestions}`;
        }

        // Update progress bar
        function updateProgress() {
            const progress = ((currentQuestionIndex + 1) / totalQuestions) * 100;
            document.getElementById('progressFill').style.width = `${Math.min(progress, 100)}%`;
        }

        // Show quiz completion
        function showQuizComplete() {
            const contentArea = document.getElementById('contentArea');
            const percentage = Math.round((score / totalQuestions) * 100);
            const sessionDuration = sessionStartTime ? Math.round((new Date() - sessionStartTime) / 60000) : 0;
            
            saveFinalResults('Quiz Mode', score, totalQuestions, percentage, sessionDuration);
            
            contentArea.innerHTML = `<div class="question-card" style="text-align: center;">
                <h2>üéâ Quiz Complete!</h2>
                <div style="background: rgba(0, 255, 136, 0.1); padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <h3>üìä Final Results</h3>
                    <p><strong>Student:</strong> ${userName}</p>
                    <p><strong>Score:</strong> ${score}/${totalQuestions} (${percentage}%)</p>
                    <p><strong>Time Spent:</strong> ${sessionDuration} minutes</p>
                    <p><strong>Completion Date:</strong> ${new Date().toLocaleString()}</p>
                </div>
                <p>${percentage >= 80 ? 'Excellent work! You\'ve mastered R data types!' : 
                     percentage >= 60 ? 'Good job! Review the data type coercion rules.' : 
                     'Keep practicing! Focus on the differences between data types!'}</p>
                <div style="margin-top: 20px;">
                    <button class="mode-btn" onclick="resetQuiz()">Restart Quiz</button>
                    <button class="mode-btn" onclick="downloadResults()">üì• Download Results</button>
                </div>
                <p style="color: #00ffcc; font-size: 0.9em; margin-top: 15px;">
                    ‚úÖ Results automatically saved to instructor's Google Sheet
                </p>
            </div>`;
        }

        // Reset quiz
        window.resetQuiz = function() {
            currentQuestionIndex = 0;
            score = 0;
            loadQuizMode();
        };

        // Play sound effects (optional)
        function playSound(type) {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                if (type === 'correct') {
                    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                    oscillator.frequency.setValueAtTime(1000, audioContext.currentTime + 0.1);
                } else {
                    oscillator.frequency.setValueAtTime(300, audioContext.currentTime);
                    oscillator.frequency.setValueAtTime(200, audioContext.currentTime + 0.1);
                }
                
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
            } catch (e) {
                // Audio not supported or blocked
            }
        }

// --- Placeholder/Mock Server Functions (Must be replaced with actual API_ENDPOINT) ---

const API_ENDPOINT = 'YOUR_LESSON_2_API_ENDPOINT_HERE'; 

function saveToServer(data) {
    console.log('--- Mock Server Save (Replace API_ENDPOINT) ---');
    console.log('Data to send:', data);
    showNotification(`‚ö†Ô∏è Using mock save. Update API_ENDPOINT for real data saving.`);
    // Actual fetch logic would go here:
    /*
    fetch(API_ENDPOINT, { ... })
    .then(response => response.json())
    .then(result => { ... })
    .catch(error => { ... });
    */
}

function saveProgress() {
    const progress = {
        userName: userName,
        score: score,
        currentQuestionIndex: currentQuestionIndex,
        storyLevels: storyLevels,
        sessionStartTime: sessionStartTime,
        timestamp: Date.now()
    };
    localStorage.setItem('r-learning-progress-L2', JSON.stringify(progress));
    
    // saveToServer is mocked:
    saveToServer({
        studentName: userName,
        mode: 'In-Progress (L2)',
        score: score,
        totalQuestions: totalQuestions,
        percentage: Math.round((score / totalQuestions) * 100) || 0,
        timeSpent: sessionStartTime ? Math.round((new Date() - sessionStartTime) / 60000) : 0,
    });
}

function saveFinalResults(mode, score, total, percentage, duration, code) {
    const results = {
        studentName: userName,
        mode: mode,
        score: score,
        totalQuestions: total,
        percentage: percentage,
        timeSpent: duration,
        completionDate: new Date(),
        lessonTitle: "R for Transcriptomics & Single-Cell - Lesson 2: Words (Data Types & Objects)",
        codeSubmitted: code || 'N/A' 
    };
    
    saveToServer(results);
}

// Show notification
function showNotification(message) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(0, 255, 136, 0.9);
        color: #000;
        padding: 10px 20px;
        border-radius: 5px;
        font-weight: bold;
        z-index: 1000;
        animation: slideIn 0.3s ease;
    `;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Download Results (Simplified for Lesson 2)
window.downloadResults = function() {
    const results = {
        student: userName,
        lesson: "Lesson 2: Words (Data Types & Objects)",
        quizScore: `${score}/${totalQuestions}`,
        quizPercentage: totalQuestions > 0 ? `${Math.round((score / totalQuestions) * 100)}%` : '0%',
        storyLevelsCompleted: storyLevels.filter(l => l.completed).length,
        completionTime: new Date().toLocaleString()
    };
    
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(results, null, 2));
    const dlAnchorElem = document.createElement('a');
    dlAnchorElem.setAttribute("href", dataStr);
    dlAnchorElem.setAttribute("download", "R_Lesson2_Results.json");
    document.body.appendChild(dlAnchorElem);
    dlAnchorElem.click();
    dlAnchorElem.remove();
    
    showNotification('üì• Results downloaded successfully! (Local copy)');
};


        // Load progress from localStorage (using 'L2' key)
        function loadProgress() {
            const saved = localStorage.getItem('r-learning-progress-L2');
            if (saved) {
                try {
                    const progress = JSON.parse(saved);
                    // Load if saved within last 24 hours
                    if (Date.now() - progress.timestamp < 24 * 60 * 60 * 1000) {
                        score = progress.score || 0;
                        currentQuestionIndex = progress.currentQuestionIndex || 0;
                        sessionStartTime = progress.sessionStartTime ? new Date(progress.sessionStartTime) : new Date();
                        
                        if (progress.storyLevels) {
                            progress.storyLevels.forEach((level, index) => {
                                if (storyLevels[index]) {
                                    storyLevels[index].completed = level.completed;
                                }
                            });
                        }
                        
                        showNotification(`üìö Welcome back, ${userName}! Progress restored for Lesson 2.`);
                    }
                } catch (e) {
                    console.log('Could not load saved progress for Lesson 2');
                }
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Start initialization directly, skipping login
            init();
        });
    </script>
</body>
</html>