<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R for Transcriptomics & Single-Cell - Lesson 1</title>
    <script src="https://cdn.jsdelivr.net/npm/ace-builds@1.32.6/src-min-noconflict/ace.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ace-builds@1.32.6/src-min-noconflict/mode-r.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ace-builds@1.32.6/src-min-noconflict/theme-monokai.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/webr@0.2.2/dist/webr.mjs" type="module"></script>
    <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            color: #00ff88;
            height: 100%;
            overflow: hidden;
        }

        html {
            height: 100%;
        }

        .container {
            display: flex;
            height: 100vh;
            position: relative;
        }

        .left-panel {
            width: 45%;
            background: rgba(0, 0, 0, 0.8);
            border-right: 2px solid #00ff88;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }

        .right-panel {
            width: 55%;
            display: flex;
            flex-direction: column;
            background: rgba(10, 10, 10, 0.9);
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            border: 2px solid #00ff88;
            border-radius: 10px;
            background: rgba(0, 255, 136, 0.1);
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.2);
        }

        .header h1 {
            margin: 0;
            font-size: 1.5rem;
            text-shadow: 0 0 10px #00ff88;
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { text-shadow: 0 0 10px #00ff88; }
            to { text-shadow: 0 0 20px #00ff88, 0 0 30px #00ff88; }
        }

        .mode-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .mode-btn {
            padding: 10px 15px;
            background: rgba(0, 255, 136, 0.2);
            border: 1px solid #00ff88;
            color: #00ff88;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .mode-btn:hover, .mode-btn.active {
            background: rgba(0, 255, 136, 0.4);
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
            border: 1px solid #00ff88;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff88, #00cc66);
            width: 0%;
            transition: width 0.5s ease;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }

        .content-area {
            flex: 1;
            overflow-y: auto;
        }

        .question-card {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid #00ff88;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.2);
        }

        .question-card h3 {
            margin-top: 0;
            color: #00ffcc;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin: 10px 0;
        }

        .option {
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #555;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .option:hover {
            background: rgba(0, 255, 136, 0.2);
            border-color: #00ff88;
        }

        .option.correct {
            background: rgba(0, 255, 0, 0.3);
            border-color: #00ff00;
        }

        .option.incorrect {
            background: rgba(255, 0, 0, 0.3);
            border-color: #ff0000;
        }

        .feedback {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }

        .feedback.correct {
            background: rgba(0, 255, 0, 0.2);
            color: #00ff00;
        }

        .feedback.incorrect {
            background: rgba(255, 0, 0, 0.2);
            color: #ff6666;
        }

        .code-editor {
            height: 300px;
            border: 2px solid #00ff88;
            border-radius: 5px;
            margin: 10px;
        }

        .output-area {
            flex: 1;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #00ff88;
            border-radius: 5px;
            margin: 10px;
            padding: 15px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
        }

        .run-btn {
            margin: 10px;
            padding: 12px 24px;
            background: linear-gradient(45deg, #00ff88, #00cc66);
            border: none;
            color: #000;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        .run-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.4);
        }

        .run-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .story-mode {
            text-align: center;
            padding: 20px;
        }

        .level-card {
            background: rgba(0, 255, 136, 0.1);
            border: 2px solid #00ff88;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .level-card:hover {
            background: rgba(0, 255, 136, 0.2);
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0, 255, 136, 0.3);
        }

        .level-card.completed {
            background: rgba(0, 255, 0, 0.2);
            border-color: #00ff00;
        }

        .level-card.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .input-field {
            width: 100%;
            padding: 8px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #00ff88;
            color: #00ff88;
            border-radius: 3px;
            font-family: inherit;
            margin: 5px 0;
        }

        .score-display {
            text-align: center;
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #00ffcc;
        }

        .typing-animation {
            overflow: hidden;
            border-right: 2px solid #00ff88;
            white-space: nowrap;
            animation: typing 3s steps(40, end), blink-caret 0.75s step-end infinite;
        }

        @keyframes typing {
            from { width: 0; }
            to { width: 100%; }
        }

        @keyframes blink-caret {
            from, to { border-color: transparent; }
            50% { border-color: #00ff88; }
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .left-panel, .right-panel {
                width: 100%;
            }
            
            .left-panel {
                height: 40vh;
            }
            
            .right-panel {
                height: 60vh;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="left-panel">
            <div class="header">
                <h1>R for Transcriptomics & Single-Cell</h1>
                <p>Lesson 1: Alphabets of R</p>
            </div>

            <div class="mode-selector">
                <button class="mode-btn active" onclick="switchMode('quiz')">Quiz Mode</button>
                <button class="mode-btn" onclick="switchMode('practice')">Practice Mode</button>
                <button class="mode-btn" onclick="switchMode('story')">R Quest</button>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <div class="score-display" id="scoreDisplay">Score: 0/0</div>

            <div class="content-area" id="contentArea">
                </div>
        </div>

        <div class="right-panel">
            <div class="code-editor" id="codeEditor"></div>
            <button class="run-btn" id="runBtn" onclick="runCode()">‚ñ∂ Run Code</button>
            <div class="output-area" id="outputArea">Welcome to the R Console! üß¨
Ready to explore transcriptomics and single-cell analysis...

Type your R code in the editor above and click "Run Code" to execute.
            </div>
        </div>
    </div>

    <script type="module">
        // Initialize WebR
        import { WebR } from 'https://cdn.jsdelivr.net/npm/webr@0.2.2/dist/webr.mjs';
        
        let webR;
        let editor;
        let currentMode = 'quiz';
        let currentQuestionIndex = 0;
        let score = 0;
        let totalQuestions = 0;
        let userName = '';
        let sessionStartTime = null;

        // Lesson data
        const lessonData = {
            "mcq": [
                {"q": "Which symbol is used for assignment in R?", "options": ["=", "<-", "->", "=="], "answer": "<-"},
                {"q": "What does # do in R?", "options": ["Starts a loop", "Adds two numbers", "Starts a comment", "Ends a function"], "answer": "Starts a comment"},
                {"q": "Which function is used to find the current working directory?", "options": ["dir()", "getwd()", "wd()", "setwd()"], "answer": "getwd()"},
                {"q": "What is the result of 2 ^ 5?", "options": ["7", "10", "25", "32"], "answer": "32"},
                {"q": "Which operator accesses columns in a data frame?", "options": ["@", "$", ":", "[]"], "answer": "$"}
            ],
            "true_false": [
                {"q": "print('Hello R') and 'Hello R' display the same output in the console.", "answer": true},
                {"q": "= and <- always behave identically in all contexts.", "answer": false},
                {"q": "Comments are executed by R.", "answer": false},
                {"q": "mean(10:20) calculates the mean of integers 10 to 20.", "answer": true},
                {"q": "A missing bracket creates a syntax error.", "answer": true}
            ],
            "fill": [
                {"q": "The function used to calculate the square root is __________.", "answer": "sqrt()"},
                {"q": "The operator used for creating sequences of numbers is __________.", "answer": ":"},
                {"q": "The function to round numbers to the nearest integer is __________.", "answer": "round()"},
                {"q": "To combine text strings, we use the __________ function.", "answer": "paste()"}
            ]
        };

        const practiceExercises = [
            {
                title: "Basic Assignment",
                description: "Create a variable 'x' and assign it the value 42",
                starter: "# Assign 42 to variable x\nx <- ",
                solution: "x <- 42\nprint(x)"
            },
            {
                title: "Comments",
                description: "Add a comment explaining what the code does",
                starter: "# Your comment here\nmean(1:10)",
                solution: "# Calculate the mean of numbers 1 to 10\nmean(1:10)"
            },
            {
                title: "Mathematical Operations",
                description: "Calculate the square root of 144",
                starter: "# Calculate square root of 144\nresult <- ",
                solution: "# Calculate square root of 144\nresult <- sqrt(144)\nprint(result)"
            }
        ];

        const storyLevels = [
            {
                id: 1,
                title: "Variable Vault",
                description: "Master the assignment operators to unlock the vault",
                challenge: "Create variables: name <- 'Scientist' and age <- 25",
                completed: false
            },
            {
                id: 2,
                title: "Comment Chamber",
                description: "Use comments to deactivate the security system",
                challenge: "Add comments to explain: x <- 10; y <- 20; sum <- x + y",
                completed: false
            },
            {
                id: 3,
                title: "Arithmetic Reactor",
                description: "Solve mathematical puzzles to power the reactor",
                challenge: "Calculate: sqrt(64), 3^4, and round(3.14159, 2)",
                completed: false
            },
            {
                id: 4,
                title: "Directory Portal",
                description: "Navigate the file system to find the portal",
                challenge: "Use getwd() to find current directory",
                completed: false
            },
            {
                id: 5,
                title: "Data Frame Door",
                description: "Access data frame columns to open the final door",
                challenge: "Create a data frame and use $ to access a column",
                completed: false
            }
        ];

        // Initialize the application
        async function init() {
            // Check if user is logged in
            if (!userName) {
                showLoginScreen();
                return;
            }
            
            try {
                // Initialize WebR
                webR = new WebR();
                await webR.init();
                
                // Initialize Ace Editor
                editor = ace.edit("codeEditor");
                editor.setTheme("ace/theme/monokai");
                editor.session.setMode("ace/mode/r");
                editor.setOptions({
                    fontSize: 14,
                    showLineNumbers: true,
                    showGutter: true,
                    highlightActiveLine: true,
                    wrap: true
                });
                
                // Set initial code
                editor.setValue("# Welcome to R!\n# Try: print('Hello, R World!')\n", -1);
                
                // Load saved progress
                loadProgress();
                
                // Initialize quiz mode
                switchMode('quiz');
                
                document.getElementById('outputArea').textContent = "‚úÖ R Console Ready!\nWebR initialized successfully. You can now run R code!\n\nTry some basic commands:\n‚Ä¢ print('Hello R!')\n‚Ä¢ 2 + 2\n‚Ä¢ sqrt(16)\n‚Ä¢ mean(1:10)";
                
            } catch (error) {
                console.error('Initialization error:', error);
                document.getElementById('outputArea').textContent = "‚ùå Error initializing R environment.\nFalling back to demo mode...\n\nYou can still practice R syntax, but code execution is limited.";
            }
        }

        // Show login screen
        function showLoginScreen() {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="question-card" style="text-align: center;">
                    <h2>üß¨ Welcome to R Learning Lab</h2>
                    <p>Enter your name to begin your transcriptomics journey:</p>
                    <input type="text" id="userNameInput" class="input-field" placeholder="Enter your full name" 
                           style="max-width: 300px; margin: 20px auto; display: block;" 
                           onkeypress="if(event.key==='Enter') startSession()">
                    <button class="mode-btn" onclick="startSession()" style="margin-top: 15px;">
                        Start Learning Session
                    </button>
                    <p style="font-size: 0.9em; color: #888; margin-top: 20px;">
                        üìä Your progress will be automatically saved and tracked
                    </p>
                </div>
            `;
            
            // Hide mode selector and progress bar during login
            document.querySelector('.mode-selector').style.display = 'none';
            document.querySelector('.progress-bar').style.display = 'none';
            document.getElementById('scoreDisplay').style.display = 'none';
        }

        // Start user session
        window.startSession = function() {
            const nameInput = document.getElementById('userNameInput');
            const name = nameInput.value.trim();
            
            if (!name) {
                alert('Please enter your name to continue.');
                return;
            }
            
            userName = name;
            sessionStartTime = new Date();
            
            // Show interface elements
            document.querySelector('.mode-selector').style.display = 'flex';
            document.querySelector('.progress-bar').style.display = 'block';
            document.getElementById('scoreDisplay').style.display = 'block';
            
            // Update header with user name
            const header = document.querySelector('.header');
            header.innerHTML = `
                <h1>R for Transcriptomics & Single-Cell</h1>
                <p>Lesson 1: Alphabets of R</p>
                <p style="color: #00ffcc; font-size: 0.9em;">üë§ Student: ${userName}</p>
            `;
            
            // Initialize the main application
            init();
        };

        // Switch between modes
        window.switchMode = function(mode) {
            currentMode = mode;
            
            // Update active button
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            //event.target.classList.add('active');
            
            // Reset state
            currentQuestionIndex = 0;
            
            switch(mode) {
                case 'quiz':
                    loadQuizMode();
                    break;
                case 'practice':
                    loadPracticeMode();
                    break;
                case 'story':
                    loadStoryMode();
                    break;
            }
        };

        // Load quiz mode
        function loadQuizMode() {
            const allQuestions = [
                ...lessonData.mcq.map(q => ({...q, type: 'mcq'})),
                ...lessonData.true_false.map(q => ({...q, type: 'true_false'})),
                ...lessonData.fill.map(q => ({...q, type: 'fill'}))
            ];
            
            totalQuestions = allQuestions.length;
            updateScore();
            
            if (currentQuestionIndex < allQuestions.length) {
                displayQuestion(allQuestions[currentQuestionIndex]);
            } else {
                showQuizComplete();
            }
        }

        // Display a question
        function displayQuestion(question) {
            const contentArea = document.getElementById('contentArea');
            let html = `<div class="question-card">
                <h3>Question ${currentQuestionIndex + 1} of ${totalQuestions}</h3>
                <p>${question.q}</p>`;

            if (question.type === 'mcq') {
                html += '<div class="options">';
                question.options.forEach((option, index) => {
                    html += `<div class="option" onclick="selectOption('${option}', '${question.answer}')">${option}</div>`;
                });
                html += '</div>';
            } else if (question.type === 'true_false') {
                html += '<div class="options">';
                html += `<div class="option" onclick="selectOption(true, ${question.answer})">True</div>`;
                html += `<div class="option" onclick="selectOption(false, ${question.answer})">False</div>`;
                html += '</div>';
            } else if (question.type === 'fill') {
                html += `<input type="text" class="input-field" id="fillAnswer" placeholder="Type your answer here..." onkeypress="if(event.key==='Enter') checkFillAnswer('${question.answer}')">`;
                html += `<button class="mode-btn" onclick="checkFillAnswer('${question.answer}')" style="margin-top: 10px;">Submit</button>`;
            }

            html += '<div id="feedback"></div></div>';
            contentArea.innerHTML = html;
            
            updateProgress();
        }

        // Handle option selection
        window.selectOption = function(selected, correct) {
            const options = document.querySelectorAll('.option');
            const feedback = document.getElementById('feedback');
            
            options.forEach(option => {
                option.style.pointerEvents = 'none';
                if (option.textContent === correct.toString() || option.textContent === correct) {
                    option.classList.add('correct');
                } else if (option.textContent === selected.toString() || option.textContent === selected) {
                    option.classList.add('incorrect');
                }
            });
            
            if (selected.toString() === correct.toString() || selected === correct) {
                feedback.innerHTML = '‚úÖ Correct! Well done!';
                feedback.className = 'feedback correct';
                score++;
                playSound('correct');
            } else {
                feedback.innerHTML = `‚ùå Incorrect. The correct answer is: ${correct}`;
                feedback.className = 'feedback incorrect';
                playSound('incorrect');
            }
            
            updateScore();
            
            setTimeout(() => {
                currentQuestionIndex++;
                loadQuizMode();
            }, 2000);
        };

        // Check fill-in-the-blank answer
        window.checkFillAnswer = function(correct) {
            const input = document.getElementById('fillAnswer');
            const answer = input.value.trim().toLowerCase();
            const correctLower = correct.toLowerCase();
            const feedback = document.getElementById('feedback');
            
            input.disabled = true;
            
            if (answer === correctLower) {
                feedback.innerHTML = '‚úÖ Correct! Well done!';
                feedback.className = 'feedback correct';
                score++;
                playSound('correct');
            } else {
                feedback.innerHTML = `‚ùå Incorrect. The correct answer is: ${correct}`;
                feedback.className = 'feedback incorrect';
                playSound('incorrect');
            }
            
            updateScore();
            
            setTimeout(() => {
                currentQuestionIndex++;
                loadQuizMode();
            }, 2000);
        };

        // Load practice mode
        function loadPracticeMode() {
            const contentArea = document.getElementById('contentArea');
            let html = '<h2>Practice Exercises</h2>';
            
            practiceExercises.forEach((exercise, index) => {
                html += `<div class="question-card">
                    <h3>${exercise.title}</h3>
                    <p>${exercise.description}</p>
                    <button class="mode-btn" onclick="loadExercise(${index})">Start Exercise</button>
                </div>`;
            });
            
            contentArea.innerHTML = html;
        }

        // Load exercise
        window.loadExercise = function(index) {
            const exercise = practiceExercises[index];
            editor.setValue(exercise.starter, -1);
            
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `<div class="question-card">
                <h3>${exercise.title}</h3>
                <p>${exercise.description}</p>
                <button class="mode-btn" onclick="showSolution(${index})">Show Solution</button>
                <button class="mode-btn" onclick="loadPracticeMode()">Back to Exercises</button>
            </div>`;
        };

        // Show solution
        window.showSolution = function(index) {
            const exercise = practiceExercises[index];
            editor.setValue(exercise.solution, -1);
        };

        // Load story mode
        function loadStoryMode() {
            const contentArea = document.getElementById('contentArea');
            let html = `<div class="story-mode">
                <h2 class="typing-animation">üß¨ R Quest: The Lab Console</h2>
                <p>The bioinformatics lab's main computer has crashed! Navigate through 5 levels to restore the system and unlock the secrets of transcriptomics.</p>
            `;
            
            storyLevels.forEach((level, index) => {
                const isLocked = index > 0 && !storyLevels[index - 1].completed;
                const cardClass = level.completed ? 'level-card completed' : isLocked ? 'level-card locked' : 'level-card';
                
                html += `<div class="${cardClass}" onclick="${isLocked ? '' : `startLevel(${index})`}">
                    <h3>${level.completed ? '‚úÖ' : isLocked ? 'üîí' : 'üîì'} Level ${level.id}: ${level.title}</h3>
                    <p>${level.description}</p>
                    ${level.completed ? '<p style="color: #00ff00;">COMPLETED</p>' : ''}
                </div>`;
            });
            
            html += '</div>';
            contentArea.innerHTML = html;
        }

        // Start story level
        window.startLevel = function(index) {
            const level = storyLevels[index];
            const contentArea = document.getElementById('contentArea');
            
            contentArea.innerHTML = `<div class="question-card">
                <h3>Level ${level.id}: ${level.title}</h3>
                <p>${level.description}</p>
                <p><strong>Challenge:</strong> ${level.challenge}</p>
                <button class="mode-btn" onclick="completeLevel(${index})">Complete Level</button>
                <button class="mode-btn" onclick="loadStoryMode()">Back to Quest</button>
            </div>`;
            
            // Set appropriate starter code based on level
            const starterCodes = [
                "# Level 1: Variable Vault\n# Create the required variables\nname <- \nage <- ",
                "# Level 2: Comment Chamber\n# Add comments to explain each line\nx <- 10\ny <- 20\nsum <- x + y",
                "# Level 3: Arithmetic Reactor\n# Solve these mathematical puzzles\nsqrt_result <- \npower_result <- \nround_result <- ",
                "# Level 4: Directory Portal\n# Find your current location\ncurrent_dir <- ",
                "# Level 5: Data Frame Door\n# Create and access data frame\ndf <- data.frame(name = c('Alice', 'Bob'), age = c(25, 30))\n# Access the name column using $\nnames <- "
            ];
            
            editor.setValue(starterCodes[index], -1);
        };

// ----------------------------------------------------
// Step 3.3: IMPORTANT: Update completeLevel to capture code
// ----------------------------------------------------

window.completeLevel = function(index) {
    storyLevels[index].completed = true;
    saveProgress();
    
    const contentArea = document.getElementById('contentArea');
    contentArea.innerHTML = `<div class="question-card">
        <h3>‚úÖ Level ${storyLevels[index].id} Complete!</h3>
        <p class="typing-animation">Command fixed. Proceed to next terminal...</p>
        <button class="mode-btn" onclick="loadStoryMode()">Continue Quest</button>
    </div>`;
    
    // Check if all levels completed
    if (storyLevels.every(level => level.completed)) {
        const sessionDuration = sessionStartTime ? Math.round((new Date() - sessionStartTime) / 60000) : 0;
        const completedLevels = storyLevels.filter(level => level.completed).length;
        
        // ‚¨áÔ∏è UPDATE: Capture final code snippet to save to sheet
        const finalCode = editor.getValue(); 

        // Save story mode completion results
        saveFinalResults('Story Mode (R Quest)', completedLevels, storyLevels.length, 100, sessionDuration, finalCode);
        
        setTimeout(() => {
            contentArea.innerHTML = `<div class="question-card" style="text-align: center;">
                <h2>üéâ SYSTEM RESTORED! üéâ</h2>
                <p class="typing-animation">You are now fluent in the Alphabets of R!</p>
                <div style="background: rgba(0, 255, 136, 0.1); padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <h3>üèÜ Quest Complete!</h3>
                    <p><strong>Student:</strong> ${userName}</p>
                    <p><strong>Levels Completed:</strong> ${completedLevels}/${storyLevels.length}</p>
                    <p><strong>Time Spent:</strong> ${sessionDuration} minutes</p>
                    <p><strong>Completion Date:</strong> ${new Date().toLocaleString()}</p>
                </div>
                <p>Congratulations! You've mastered the basics of R programming for transcriptomics and single-cell analysis.</p>
                <div style="margin-top: 20px;">
                    <button class="mode-btn" onclick="loadStoryMode()">View Quest Summary</button>
                    <button class="mode-btn" onclick="downloadResults()">üì• Download Results</button>
                </div>
                <p style="color: #00ffcc; font-size: 0.9em; margin-top: 15px;">
                    ‚úÖ Results automatically saved to instructor's Google Sheet
                </p>
            </div>`;
        }, 2000);
    }
};

        // Run R code
        window.runCode = async function() {
            const code = editor.getValue();
            const outputArea = document.getElementById('outputArea');
            const runBtn = document.getElementById('runBtn');
            
            if (!code.trim()) {
                outputArea.textContent = "Please enter some R code to execute.";
                return;
            }
            
            runBtn.disabled = true;
            runBtn.textContent = "Running...";
            outputArea.textContent = "Executing R code...\n";
            
            try {
                if (webR) {
                    // Execute with WebR
                    const result = await webR.evalR(code);
                    const output = await result.toJs();
                    
                    if (output && output.values) {
                        outputArea.textContent = `> ${code}\n\n${output.values.join('\n')}`;
                    } else {
                        outputArea.textContent = `> ${code}\n\nCode executed successfully.`;
                    }
                } else {
                    // Fallback simulation
                    simulateRExecution(code, outputArea);
                }
            } catch (error) {
                outputArea.textContent = `> ${code}\n\nError: ${error.message}`;
            } finally {
                runBtn.disabled = false;
                runBtn.textContent = "‚ñ∂ Run Code";
            }
        };

        // Simulate R execution for demo purposes
        function simulateRExecution(code, outputArea) {
            const lines = code.split('\n').filter(line => line.trim() && !line.trim().startsWith('#'));
            let output = `> ${code}\n\n`;
            
            lines.forEach(line => {
                const trimmed = line.trim();
                
                // Simple pattern matching for common R operations
                if (trimmed.includes('print(')) {
                    const match = trimmed.match(/print\(['"](.+?)['"]\)/);
                    if (match) output += `[1] "${match[1]}"\n`;
                } else if (trimmed.match(/^\d+\s*[\+\-\*\/\^]\s*\d+$/)) {
                    try {
                        const result = eval(trimmed.replace('^', '**'));
                        output += `[1] ${result}\n`;
                    } catch (e) {
                        output += `Error in evaluation\n`;
                    }
                } else if (trimmed.includes('sqrt(')) {
                    const match = trimmed.match(/sqrt\((\d+)\)/);
                    if (match) output += `[1] ${Math.sqrt(parseInt(match[1]))}\n`;
                } else if (trimmed.includes('mean(')) {
                    const match = trimmed.match(/mean\((\d+):(\d+)\)/);
                    if (match) {
                        const start = parseInt(match[1]);
                        const end = parseInt(match[2]);
                        const mean = (start + end) / 2;
                        output += `[1] ${mean}\n`;
                    }
                } else if (trimmed.includes('getwd()')) {
                    output += `[1] "/home/user/r-workspace"\n`;
                } else if (trimmed.includes('<-')) {
                    output += `# Variable assigned\n`;
                } else {
                    output += `# Code executed\n`;
                }
            });
            
            outputArea.textContent = output;
        }

        // Update score display
        function updateScore() {
            document.getElementById('scoreDisplay').textContent = `Score: ${score}/${totalQuestions}`;
        }

        // Update progress bar
        function updateProgress() {
            const progress = ((currentQuestionIndex + 1) / totalQuestions) * 100;
            document.getElementById('progressFill').style.width = `${Math.min(progress, 100)}%`;
        }

        // Show quiz completion
        function showQuizComplete() {
            const contentArea = document.getElementById('contentArea');
            const percentage = Math.round((score / totalQuestions) * 100);
            const sessionDuration = sessionStartTime ? Math.round((new Date() - sessionStartTime) / 60000) : 0;
            
            // Save final results to the server
            saveFinalResults('Quiz Mode', score, totalQuestions, percentage, sessionDuration);
            
            contentArea.innerHTML = `<div class="question-card" style="text-align: center;">
                <h2>üéâ Quiz Complete!</h2>
                <div style="background: rgba(0, 255, 136, 0.1); padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <h3>üìä Final Results</h3>
                    <p><strong>Student:</strong> ${userName}</p>
                    <p><strong>Score:</strong> ${score}/${totalQuestions} (${percentage}%)</p>
                    <p><strong>Time Spent:</strong> ${sessionDuration} minutes</p>
                    <p><strong>Completion Date:</strong> ${new Date().toLocaleString()}</p>
                </div>
                <p>${percentage >= 80 ? 'Excellent work! You\'ve mastered the R alphabets!' : 
                     percentage >= 60 ? 'Good job! Review the topics you missed.' : 
                     'Keep practicing! You\'ll get there!'}</p>
                <div style="margin-top: 20px;">
                    <button class="mode-btn" onclick="resetQuiz()">Restart Quiz</button>
                    <button class="mode-btn" onclick="downloadResults()">üì• Download Results</button>
                </div>
                <p style="color: #00ffcc; font-size: 0.9em; margin-top: 15px;">
                    ‚úÖ Results automatically saved to instructor's Google Sheet
                </p>
            </div>`;
        }

        // Reset quiz
        window.resetQuiz = function() {
            currentQuestionIndex = 0;
            score = 0;
            loadQuizMode();
        };

        // Play sound effects (optional)
        function playSound(type) {
            // Simple audio feedback using Web Audio API
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                if (type === 'correct') {
                    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                    oscillator.frequency.setValueAtTime(1000, audioContext.currentTime + 0.1);
                } else {
                    oscillator.frequency.setValueAtTime(300, audioContext.currentTime);
                    oscillator.frequency.setValueAtTime(200, audioContext.currentTime + 0.1);
                }
                
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
            } catch (e) {
                // Audio not supported or blocked
            }
        }

// ----------------------------------------------------
// Step 3.1: Define your new server-side save function
// ----------------------------------------------------

const API_ENDPOINT = 'https://script.google.com/macros/library/d/1OveeDCkYAHbpdqoj8KeEAenRJxEtQ3NVLtcfm1Zir6q4_D3o0_hE98GR/3'; // <--- PASTE THE URL FROM STEP 2.3!

function saveToServer(data) {
    // Send data to the Google Apps Script Web App
    fetch(API_ENDPOINT, {
        method: 'POST',
        mode: 'no-cors',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            console.log('‚úÖ Data saved to Google Sheet:', result);
            showNotification(`‚úÖ Progress saved to instructor's Google Sheet`);
        } else {
             throw new Error(result.message);
        }
    })
    .catch(error => {
        console.error('‚ùå Error sending data to server:', error);
        showNotification(`‚ùå Failed to save progress! Check console.`);
    });
}

// ----------------------------------------------------
// Step 3.2: Update core logic to use the new function
// ----------------------------------------------------

// Save progress to localStorage (for continuity) AND to the server
function saveProgress() {
    const progress = {
        userName: userName,
        score: score,
        currentQuestionIndex: currentQuestionIndex,
        storyLevels: storyLevels,
        sessionStartTime: sessionStartTime,
        timestamp: Date.now()
    };
    localStorage.setItem('r-learning-progress', JSON.stringify(progress));
    
    // Send a summary save to the server
    saveToServer({
        studentName: userName,
        mode: 'In-Progress',
        score: score,
        totalQuestions: totalQuestions,
        percentage: Math.round((score / totalQuestions) * 100) || 0,
        timeSpent: sessionStartTime ? Math.round((new Date() - sessionStartTime) / 60000) : 0,
    });
}

// Save final results when a mode is completed
function saveFinalResults(mode, score, total, percentage, duration, code) {
    const results = {
        studentName: userName,
        mode: mode,
        score: score,
        totalQuestions: total,
        percentage: percentage,
        timeSpent: duration,
        completionDate: new Date(),
        lessonTitle: "R for Transcriptomics & Single-Cell - Lesson 1: Alphabets of R",
        codeSubmitted: code // This is the new field
    };
    
    saveToServer(results);
}

        // Show notification
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: rgba(0, 255, 136, 0.9);
                color: #000;
                padding: 10px 20px;
                border-radius: 5px;
                font-weight: bold;
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

// ----------------------------------------------------
// Step 3.4: Update downloadResults to reflect new reality
// ----------------------------------------------------
window.downloadResults = function() {
    // This function can now be removed or simplified since the primary save is server-side.
    // If you want to keep local download, retain the existing code for it,
    // but change the notification:
    showNotification('üì• Results downloaded successfully! (Server copy is primary)');
};


        // Load progress from localStorage
        function loadProgress() {
            const saved = localStorage.getItem('r-learning-progress');
            if (saved) {
                try {
                    const progress = JSON.parse(saved);
                    // Only load if saved within last 24 hours and matches current user
                    if (Date.now() - progress.timestamp < 24 * 60 * 60 * 1000 && 
                        progress.userName === userName) {
                        score = progress.score || 0;
                        currentQuestionIndex = progress.currentQuestionIndex || 0;
                        sessionStartTime = progress.sessionStartTime ? new Date(progress.sessionStartTime) : new Date();
                        
                        if (progress.storyLevels) {
                            progress.storyLevels.forEach((level, index) => {
                                if (storyLevels[index]) {
                                    storyLevels[index].completed = level.completed;
                                }
                            });
                        }
                        
                        showNotification(`üìö Welcome back, ${userName}! Progress restored.`);
                    }
                } catch (e) {
                    console.log('Could not load saved progress');
                }
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Always start with login screen
            showLoginScreen();
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'992faf8f97360fac',t:'MTc2MTIwNjI3MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>

